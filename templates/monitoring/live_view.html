{% extends "base.html" %}

{% block title %}Surveillance Live - Monitoring{% endblock %}

{% block content %}
<div class="container-fluid py-4" style="margin-top: 70px;">
    
    <!-- En-tête de la surveillance live -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-video me-2"></i>Surveillance Live</h2>
                    <p class="text-muted">Surveillance en temps réel de toutes les caméras</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" id="fullscreen-btn">
                        <i class="fas fa-expand me-1"></i> Plein écran
                    </button>
                    <button class="btn btn-outline-success" id="record-all-btn">
                        <i class="fas fa-record-vinyl me-1"></i> Enregistrer tout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Grille des caméras -->
        <div class="col-12">
            <div class="card bg-dark">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="text-light mb-0">
                        <i class="fas fa-th me-2"></i>
                        Grille Multi-Caméras ({{ cameras|length }} caméras)
                    </h5>
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" id="layout-selector">
                            <option value="2x2">Grille 2x2</option>
                            <option value="3x3" selected>Grille 3x3</option>
                            <option value="4x4">Grille 4x4</option>
                            <option value="single">Vue unique</option>
                        </select>
                        <button class="btn btn-outline-light btn-sm" id="auto-cycle-btn">
                            <i class="fas fa-sync-alt me-1"></i> Auto
                        </button>
                    </div>
                </div>
                <div class="card-body p-3">
                    <div class="camera-grid-container">
                        <!-- Webcam option -->
                        <div class="camera-feed-card" data-camera-id="webcam">
                            <div class="camera-feed-header">
                                <span class="camera-title">🎥 Webcam PC</span>
                                <span class="camera-status online">
                                    <i class="fas fa-circle"></i> Live
                                </span>
                            </div>
                            <div class="camera-feed-container">
                                <canvas class="camera-feed" width="320" height="240" data-camera-id="webcam"></canvas>
                                <div class="camera-controls">
                                    <button class="btn btn-sm btn-primary" onclick="focusCamera('webcam')">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="recordCamera('webcam')">
                                        <i class="fas fa-record-vinyl"></i>
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="takeSnapshot('webcam')">
                                        <i class="fas fa-camera"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Caméras de surveillance -->
                        {% for camera in cameras %}
                        <div class="camera-feed-card" data-camera-id="{{ camera.id }}">
                            <div class="camera-feed-header">
                                <span class="camera-title">📹 {{ camera.name }}</span>
                                <span class="camera-status {{ camera.status }}">
                                    <i class="fas fa-circle"></i> {{ camera.get_status_display }}
                                </span>
                            </div>
                            <div class="camera-feed-container">
                                <canvas class="camera-feed" width="320" height="240" data-camera-id="{{ camera.id }}"></canvas>
                                <div class="camera-overlay">
                                    <span class="camera-location">{{ camera.zone.name }}</span>
                                    <span class="camera-timestamp" id="timestamp-{{ camera.id }}"></span>
                                </div>
                                <div class="camera-controls">
                                    <button class="btn btn-sm btn-primary" onclick="focusCamera({{ camera.id }})">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="recordCamera({{ camera.id }})">
                                        <i class="fas fa-record-vinyl"></i>
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="takeSnapshot({{ camera.id }})">
                                        <i class="fas fa-camera"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alertes récentes -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card bg-secondary text-light">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Alertes Récentes
                    </h6>
                </div>
                <div class="card-body">
                    <div id="recent-alerts-container">
                        <!-- Les alertes seront chargées ici -->
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-shield-alt fa-2x mb-2"></i>
                            <div>Aucune alerte récente</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.camera-grid-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 15px;
    max-height: 70vh;
    overflow-y: auto;
}

.camera-feed-card {
    background: #2d3436;
    border-radius: 8px;
    overflow: hidden;
    position: relative;
    transition: transform 0.2s ease;
}

.camera-feed-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}

.camera-feed-header {
    background: #636e72;
    padding: 8px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.camera-title {
    font-weight: bold;
    color: white;
}

.camera-status {
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.camera-status.online { color: #00b894; }
.camera-status.offline { color: #e17055; }
.camera-status.warning { color: #fdcb6e; }

.camera-feed-container {
    position: relative;
}

.camera-feed {
    width: 100%;
    height: auto;
    display: block;
    background: #000;
}

.camera-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.8));
    padding: 10px;
    color: white;
    font-size: 12px;
}

.camera-location {
    font-weight: bold;
}

.camera-timestamp {
    float: right;
    opacity: 0.8;
}

.camera-controls {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    gap: 5px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.camera-feed-card:hover .camera-controls {
    opacity: 1;
}

/* Layouts de grille */
.layout-2x2 .camera-grid-container {
    grid-template-columns: repeat(2, 1fr);
}

.layout-3x3 .camera-grid-container {
    grid-template-columns: repeat(3, 1fr);
}

.layout-4x4 .camera-grid-container {
    grid-template-columns: repeat(4, 1fr);
}

.layout-single .camera-grid-container {
    grid-template-columns: 1fr;
}

.layout-single .camera-feed-card {
    max-width: 800px;
    margin: 0 auto;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let cameraStreams = {};
let webcamStream = null;
let isRecording = {};

document.addEventListener('DOMContentLoaded', function() {
    initializeLiveView();
    setupEventListeners();
});

function initializeLiveView() {
    console.log('🚀 Initialisation de la surveillance live');
    
    // Initialiser la webcam
    initializeWebcamFeed();
    
    // Initialiser les caméras de surveillance
    {% for camera in cameras %}
    initializeCameraFeed({{ camera.id }});
    {% endfor %}
    
    // Démarrer la mise à jour des timestamps
    startTimestampUpdates();
}

function initializeWebcamFeed() {
    navigator.mediaDevices.getUserMedia({ 
        video: { 
            width: { ideal: 320 }, 
            height: { ideal: 240 } 
        }, 
        audio: false 
    })
    .then(function(stream) {
        webcamStream = stream;
        const canvas = document.querySelector('[data-camera-id="webcam"]');
        const video = document.createElement('video');
        video.srcObject = stream;
        video.autoplay = true;
        video.playsInline = true;
        
        video.addEventListener('loadedmetadata', function() {
            video.play();
            drawVideoToCanvas(video, canvas, 'webcam');
        });
        
        console.log('✅ Webcam initialisée');
    })
    .catch(function(error) {
        console.warn('⚠️ Webcam non disponible:', error);
        showNoVideoMessage(document.querySelector('[data-camera-id="webcam"]'), '🎥 Webcam non disponible');
    });
}

function initializeCameraFeed(cameraId) {
    // Pour l'instant, afficher un message de caméra simulée
    const canvas = document.querySelector(`[data-camera-id="${cameraId}"]`);
    showSimulatedCamera(canvas, cameraId);
}

function drawVideoToCanvas(video, canvas, cameraId) {
    const ctx = canvas.getContext('2d');
    
    function draw() {
        if (!video.paused && !video.ended && webcamStream) {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Ajouter timestamp
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(5, canvas.height - 25, 150, 20);
            ctx.fillStyle = 'white';
            ctx.font = '12px Arial';
            ctx.fillText(new Date().toLocaleTimeString(), 8, canvas.height - 10);
            
            requestAnimationFrame(draw);
        }
    }
    draw();
}

function showSimulatedCamera(canvas, cameraId) {
    const ctx = canvas.getContext('2d');
    
    function drawSimulated() {
        // Fond avec gradient
        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        gradient.addColorStop(0, '#2d3436');
        gradient.addColorStop(1, '#636e72');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Grille de simulation
        ctx.strokeStyle = 'rgba(255,255,255,0.1)';
        ctx.lineWidth = 1;
        for(let i = 0; i < canvas.width; i += 20) {
            ctx.beginPath();
            ctx.moveTo(i, 0);
            ctx.lineTo(i, canvas.height);
            ctx.stroke();
        }
        for(let j = 0; j < canvas.height; j += 20) {
            ctx.beginPath();
            ctx.moveTo(0, j);
            ctx.lineTo(canvas.width, j);
            ctx.stroke();
        }
        
        // Icône caméra
        ctx.fillStyle = 'rgba(255,255,255,0.8)';
        ctx.font = '30px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('📹', canvas.width/2, canvas.height/2 - 10);
        
        // Text "Caméra simulée"
        ctx.font = '14px Arial';
        ctx.fillText('Caméra simulée', canvas.width/2, canvas.height/2 + 20);
        
        // Timestamp
        ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        ctx.fillRect(5, canvas.height - 25, 150, 20);
        ctx.fillStyle = 'white';
        ctx.font = '12px Arial';
        ctx.textAlign = 'left';
        ctx.fillText(new Date().toLocaleTimeString(), 8, canvas.height - 10);
        
        setTimeout(drawSimulated, 1000); // Mise à jour chaque seconde
    }
    
    drawSimulated();
}

function showNoVideoMessage(canvas, message) {
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#fff';
    ctx.font = '14px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(message, canvas.width/2, canvas.height/2);
}

function setupEventListeners() {
    // Gestionnaire de layout
    document.getElementById('layout-selector').addEventListener('change', function(e) {
        const container = document.querySelector('.camera-grid-container').parentElement;
        container.className = container.className.replace(/layout-\w+/g, '');
        container.classList.add('layout-' + e.target.value);
    });
    
    // Plein écran
    document.getElementById('fullscreen-btn').addEventListener('click', function() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
        } else {
            document.exitFullscreen();
        }
    });
}

function focusCamera(cameraId) {
    console.log('Focus sur caméra:', cameraId);
    // Rediriger vers le dashboard avec cette caméra sélectionnée
    window.location.href = `/dashboard/?camera=${cameraId}`;
}

function recordCamera(cameraId) {
    if (isRecording[cameraId]) {
        console.log('Arrêt enregistrement caméra:', cameraId);
        isRecording[cameraId] = false;
    } else {
        console.log('Démarrage enregistrement caméra:', cameraId);
        isRecording[cameraId] = true;
    }
}

function takeSnapshot(cameraId) {
    console.log('Capture caméra:', cameraId);
    const canvas = document.querySelector(`[data-camera-id="${cameraId}"]`);
    const link = document.createElement('a');
    link.download = `surveillance-${cameraId}-${new Date().getTime()}.png`;
    link.href = canvas.toDataURL();
    link.click();
}

function startTimestampUpdates() {
    setInterval(function() {
        {% for camera in cameras %}
        const timestampElement = document.getElementById('timestamp-{{ camera.id }}');
        if (timestampElement) {
            timestampElement.textContent = new Date().toLocaleTimeString();
        }
        {% endfor %}
    }, 1000);
}
</script>
{% endblock %} 